# 差分隐私在 RAG 检索中的应用

> RAG-Shield 系列博客第四篇：如何在保护用户隐私的同时提供高质量的检索服务

## 1. 引言：RAG 系统的隐私困境

在传统的 RAG（Retrieval-Augmented Generation）系统中，用户的每一次查询都会完整地发送到检索服务器。这带来了严重的隐私风险：

```
┌─────────────────────────────────────────────────────────────┐
│                    RAG 隐私威胁模型                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   用户查询                    检索服务器                     │
│   ┌──────┐                   ┌──────────┐                   │
│   │ 查询 │ ───────────────► │ 服务器   │                   │
│   │"我的症│    完整暴露!     │ 知道你   │                   │
│   │状是..."│                 │ 查了什么  │                   │
│   └──────┘                   └──────────┘                   │
│                                    │                         │
│                                    ▼                         │
│                              ┌──────────┐                   │
│                              │ 行为画像 │                   │
│                              │ 数据售卖 │                   │
│                              │ 定向攻击 │                   │
│                              └──────────┘                   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**真实场景威胁**：
- 医疗咨询 RAG：查询内容可能泄露用户健康状况
- 法律咨询 RAG：查询可能暴露用户法律纠纷
- 企业知识库：查询可能泄露商业机密

**核心问题**：如何在不完全信任服务器的情况下，仍能获得有用的检索结果？

---

## 2. 差分隐私：数学化的隐私保护

### 2.1 直觉理解

差分隐私（Differential Privacy, DP）的核心思想可以用一句话概括：

> **无论你是否参与数据集，对分析结果的影响都微乎其微。**

想象一个场景：你担心参与某项调查会暴露你的信息。差分隐私保证：即使攻击者知道除你之外所有人的信息，他也无法从最终结果中推断出你的具体数据。

```
┌─────────────────────────────────────────────────────────────┐
│               差分隐私的直觉理解                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   数据集 D₁ (包含 Alice)        数据集 D₂ (不含 Alice)      │
│   ┌─────────────────┐          ┌─────────────────┐          │
│   │ Alice: 疾病A    │          │                 │          │
│   │ Bob:   健康     │          │ Bob:   健康     │          │
│   │ Carol: 疾病B    │          │ Carol: 疾病B    │          │
│   └────────┬────────┘          └────────┬────────┘          │
│            │                            │                    │
│            ▼                            ▼                    │
│      ┌──────────┐                ┌──────────┐               │
│      │ 添加噪声 │                │ 添加噪声 │               │
│      └────┬─────┘                └────┬─────┘               │
│           │                           │                      │
│           ▼                           ▼                      │
│      输出: 33%                   输出: 32%                   │
│                                                              │
│      两个输出几乎无法区分 → Alice 的隐私得到保护            │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 形式化定义

差分隐私有一个精确的数学定义：

**ε-差分隐私**：对于任意相邻数据集 D₁ 和 D₂（只差一条记录），以及任意输出集合 S：

```
P[M(D₁) ∈ S] ≤ e^ε × P[M(D₂) ∈ S]
```

其中：
- **ε (epsilon)**：隐私参数，越小隐私保护越强
- **M**：随机化机制（算法）
- **e^ε**：概率放大因子

**ε 的直觉理解**：

```
┌─────────────────────────────────────────────────────────────┐
│                    ε 值与隐私强度                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ε = 0.01  ████████████████████████████████  极强隐私       │
│            攻击者几乎无法区分                                │
│                                                              │
│  ε = 0.1   ██████████████████████            强隐私         │
│            推荐用于敏感数据                                  │
│                                                              │
│  ε = 1.0   ████████████                      中等隐私       │
│            常用默认值                                        │
│                                                              │
│  ε = 10    ████                              弱隐私         │
│            主要用于公开数据                                  │
│                                                              │
│  ε → ∞     █                                 无隐私         │
│            等同于原始数据发布                                │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 在 RAG 检索中应用差分隐私

### 3.1 问题建模

在 RAG 系统中，我们需要保护的是**检索分数**。当用户查询时，系统返回最相关的 k 个文档。差分隐私可以通过对检索分数添加噪声来保护用户查询。

```
┌─────────────────────────────────────────────────────────────┐
│                 DP-RAG 检索流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   用户查询          向量检索            添加噪声             │
│   ┌──────┐         ┌──────┐           ┌──────┐              │
│   │Query │ ──────► │相似度│ ────────► │ + 噪声│             │
│   │Embed │         │计算  │           │      │              │
│   └──────┘         └──────┘           └──────┘              │
│                        │                   │                 │
│                        ▼                   ▼                 │
│               原始分数:              噪声分数:               │
│               Doc1: 0.95            Doc1: 0.92              │
│               Doc2: 0.87            Doc2: 0.91  ← 排名变化! │
│               Doc3: 0.82            Doc3: 0.79              │
│                                                              │
│   隐私保护: 攻击者无法精确推断用户查询了什么                 │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 敏感度分析

要添加正确量级的噪声，我们需要分析检索分数的**敏感度**（Sensitivity）：

> 敏感度 = 单条记录变化时，输出的最大变化量

对于相似度分数（通常归一化到 [0, 1]）：
- **全局敏感度**: Δf = 1（分数范围）
- **局部敏感度**: 取决于具体查询

```
┌─────────────────────────────────────────────────────────────┐
│                    敏感度与噪声校准                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   敏感度 Δf                 噪声量级                         │
│      │                         │                             │
│      │    噪声 = Δf / ε       │                             │
│      │         ↓               │                             │
│      ▼                         ▼                             │
│   ┌──────┐   ε=0.1         ┌──────┐                         │
│   │ Δf=1 │ ──────────────► │噪声=10│  高噪声，强隐私        │
│   └──────┘                 └──────┘                         │
│                                                              │
│   ┌──────┐   ε=1.0         ┌──────┐                         │
│   │ Δf=1 │ ──────────────► │噪声=1 │  中等噪声              │
│   └──────┘                 └──────┘                         │
│                                                              │
│   ┌──────┐   ε=10          ┌──────┐                         │
│   │ Δf=1 │ ──────────────► │噪声=0.1│ 低噪声，弱隐私        │
│   └──────┘                 └──────┘                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 噪声机制详解

### 4.1 Laplace 机制

Laplace 机制是最经典的差分隐私机制，提供 **ε-DP** 保证。

**机制**：添加服从 Laplace 分布的噪声
```
噪声 ~ Laplace(0, Δf/ε)
```

**分布特点**：
```
┌─────────────────────────────────────────────────────────────┐
│                  Laplace 分布                                │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│                         ▲                                    │
│                        ╱│╲                                   │
│                       ╱ │ ╲                                  │
│                      ╱  │  ╲                                 │
│                     ╱   │   ╲                                │
│                    ╱    │    ╲                               │
│                   ╱     │     ╲                              │
│                  ╱      │      ╲                             │
│             ────╱───────┼───────╲────                        │
│          -3σ  -2σ  -σ   0   σ   2σ   3σ                     │
│                                                              │
│   特点: 尖峰、重尾，小噪声概率高                             │
│   适用: 纯 ε-DP，数值查询                                    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 Gaussian 机制

Gaussian 机制提供 **(ε, δ)-DP** 保证，适用于高维数据。

**机制**：添加高斯噪声
```
噪声 ~ N(0, σ²)
其中 σ ≥ Δf × √(2ln(1.25/δ)) / ε
```

**与 Laplace 对比**：

```
┌─────────────────────────────────────────────────────────────┐
│              Laplace vs Gaussian 机制对比                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   特性              Laplace           Gaussian               │
│   ─────────────────────────────────────────────────          │
│   隐私保证          纯 ε-DP           (ε,δ)-DP               │
│   噪声分布          尖峰重尾          钟形曲线               │
│   极端噪声概率      较高              较低                   │
│   高维数据          噪声累积大        更紧凑                 │
│   计算复杂度        低                低                     │
│                                                              │
│   ┌─────────────────────────────────────────────┐           │
│   │        Laplace          Gaussian            │           │
│   │          ╱╲               ___               │           │
│   │         ╱  ╲            ╱    ╲              │           │
│   │        ╱    ╲         ╱        ╲            │           │
│   │     __╱      ╲__    _╱          ╲_          │           │
│   └─────────────────────────────────────────────┘           │
│                                                              │
│   推荐: 单次查询用 Laplace，多维/多次查询用 Gaussian         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 隐私预算管理

### 5.1 组合定理

差分隐私有一个重要特性：**隐私会累积消耗**。每次查询都会消耗一部分隐私预算。

**基础组合定理**：k 次 ε-DP 查询后，总隐私损失为 **k × ε**。

```
┌─────────────────────────────────────────────────────────────┐
│                    隐私预算消耗                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   初始预算: ε_total = 1.0                                    │
│                                                              │
│   查询1 (ε=0.1)  ████████████████████░░░░  剩余: 0.9        │
│   查询2 (ε=0.1)  ████████████████████░░░░  剩余: 0.8        │
│   查询3 (ε=0.2)  ████████████████░░░░░░░░  剩余: 0.6        │
│   查询4 (ε=0.1)  ██████████████░░░░░░░░░░  剩余: 0.5        │
│   ...                                                        │
│   查询10         ░░░░░░░░░░░░░░░░░░░░░░░░  预算耗尽!         │
│                                                              │
│   ⚠️  预算耗尽后，继续查询将违反隐私保证                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 高级组合定理

对于多次查询，高级组合定理提供更紧的界：

```
总隐私损失 ≤ √(2k × ln(1/δ)) × ε + k × ε × (e^ε - 1)
```

这意味着实际隐私损失比简单相加要小！

```
┌─────────────────────────────────────────────────────────────┐
│              基础 vs 高级组合定理                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   100次查询，每次 ε=0.1:                                     │
│                                                              │
│   基础组合: 100 × 0.1 = 10.0                                 │
│   高级组合: ≈ 2.5  (节省约 75%!)                             │
│                                                              │
│   ┌─────────────────────────────────────────────┐           │
│   │  累积隐私损失                                │           │
│   │   ▲                                         │           │
│   │10 │            基础组合 ────────────────    │           │
│   │   │          ╱                              │           │
│   │ 5 │        ╱     高级组合 ─────────         │           │
│   │   │      ╱    ╱                             │           │
│   │   │    ╱  ╱                                 │           │
│   │   │  ╱╱                                     │           │
│   │   └──────────────────────────► 查询次数    │           │
│   │      20   40   60   80   100                │           │
│   └─────────────────────────────────────────────┘           │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 查询隐私保护

除了对检索分数添加噪声，我们还可以直接保护用户查询本身。

### 6.1 查询扰动

在发送查询之前，对查询向量添加噪声：

```
┌─────────────────────────────────────────────────────────────┐
│                    查询扰动机制                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   原始查询向量                 扰动后向量                    │
│   ┌─────────────┐             ┌─────────────┐               │
│   │ [0.5, 0.3,  │   + 噪声   │ [0.48, 0.35,│               │
│   │  0.8, ...]  │ ─────────► │  0.82, ...] │               │
│   └─────────────┘             └─────────────┘               │
│                                                              │
│   效果: 服务器只能看到扰动后的查询                           │
│   权衡: 噪声越大隐私越好，但检索质量下降                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 伪查询混淆（k-匿名性）

将真实查询混入多个伪查询中：

```
┌─────────────────────────────────────────────────────────────┐
│                  伪查询混淆 (k=5)                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   客户端                           服务器                    │
│   ┌──────────────┐                ┌──────────────┐          │
│   │ 真实查询 Q   │                │ 收到5个查询  │          │
│   │              │   混合发送     │ Q₁, Q₂, Q₃,  │          │
│   │ 生成4个伪查询│ ────────────► │ Q₄, Q₅       │          │
│   │ Q₁, Q₂, Q₃,  │                │              │          │
│   │ Q₄           │                │ 无法区分哪个 │          │
│   └──────────────┘                │ 是真实查询!  │          │
│                                    └──────────────┘          │
│        ↓                                  ↓                  │
│   收到5组结果                        返回5组结果             │
│   提取真实结果                                               │
│                                                              │
│   隐私保证: 服务器只知道用户查询了这5个之一                  │
│   开销: 带宽和计算增加 5 倍                                  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 隐私-效用权衡

差分隐私的核心权衡：**隐私越强，效用越低**。

### 7.1 权衡曲线

```
┌─────────────────────────────────────────────────────────────┐
│                  隐私-效用权衡曲线                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   检索准确率                                                 │
│   (Recall@10)                                                │
│       ▲                                                      │
│   1.0 │                              ●───────────────       │
│       │                         ●                            │
│   0.8 │                    ●                                 │
│       │               ●                                      │
│   0.6 │          ●                                          │
│       │     ●                                                │
│   0.4 │●                                                     │
│       │                                                      │
│   0.2 │                                                      │
│       │                                                      │
│       └──────────────────────────────────────────► ε        │
│         0.01  0.1   0.5   1.0   2.0   5.0   10              │
│                                                              │
│         强隐私  ◄─────────────────────────►  弱隐私         │
│         低效用                                高效用         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 实验结果示例

| ε 值 | 噪声量级 | Recall@10 | 排名变化率 | 适用场景 |
|------|---------|-----------|-----------|----------|
| 0.01 | 极大 | 45% | 85% | 高敏感数据 |
| 0.1 | 大 | 72% | 45% | 医疗/法律咨询 |
| 0.5 | 中 | 88% | 18% | 一般隐私需求 |
| 1.0 | 小 | 94% | 8% | 常规应用 |
| 5.0 | 极小 | 99% | 1% | 公开数据 |

---

## 8. RAG-Shield 实现

RAG-Shield 提供了完整的差分隐私保护实现：

### 8.1 快速上手

```python
from ragshield.privacy import create_privacy_guard, PrivacyLevel

# 创建隐私保护的检索器
guard = create_privacy_guard(retriever, level=PrivacyLevel.HIGH)

# 进行隐私保护检索
result = guard.retrieve(query_embedding, top_k=5)

# 查看隐私消耗
print(f"隐私消耗: ε={result.epsilon_spent}")
print(f"剩余预算: {result.budget_status.remaining_epsilon}")
```

### 8.2 隐私级别预设

| 级别 | ε/查询 | 查询保护 | 适用场景 |
|------|--------|---------|----------|
| MINIMAL | 1.0 | 否 | 测试/公开数据 |
| LOW | 0.5 | 否 | 低敏感度数据 |
| MEDIUM | 0.2 | 扰动 | 一般应用 |
| HIGH | 0.1 | 扰动 | 敏感数据 |
| MAXIMUM | 0.05 | k-匿名 | 高度敏感数据 |

---

## 9. 总结与最佳实践

### 9.1 关键要点

1. **差分隐私提供数学化的隐私保证**，而非启发式保护
2. **ε 越小隐私越强**，但效用会下降
3. **隐私预算会累积消耗**，需要谨慎管理
4. **多种保护可以叠加**：DP检索 + 查询扰动 + 伪查询

### 9.2 最佳实践

```
┌─────────────────────────────────────────────────────────────┐
│                    最佳实践清单                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ✓ 根据数据敏感度选择合适的 ε 值                            │
│  ✓ 使用隐私预算管理器追踪累积消耗                           │
│  ✓ 对高敏感查询使用更强的保护                               │
│  ✓ 定期轮换/重置隐私预算（如每日重置）                      │
│  ✓ 监控隐私消耗，设置告警阈值                               │
│  ✓ 在隐私和效用之间找到适合业务的平衡点                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 9.3 进一步阅读

- Dwork, C. & Roth, A. (2014). The Algorithmic Foundations of Differential Privacy
- USENIX Security 2025: PoisonedRAG - Knowledge Corruption Attacks on RAG
- ACM Web 2025: RAGForensics - Attack Tracing in RAG Systems

---

## 下一篇预告

**Blog 5: RAG 投毒攻击溯源技术**

当攻击已经发生，如何追溯定位是哪些文档导致了错误输出？我们将介绍影响分析和攻击溯源技术。

---

*RAG-Shield: 为 RAG 系统提供全方位的安全防护*

*GitHub: https://github.com/SidereusHu/RAG-Shield*
